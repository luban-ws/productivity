# é’é¸Ÿ (Qingniao)

> **ç›¸è§æ—¶éš¾åˆ«äº¦éš¾ï¼Œä¸œé£æ— åŠ›ç™¾èŠ±æ®‹ã€‚**
> **æ˜¥èš•åˆ°æ­»ä¸æ–¹å°½ï¼Œèœ¡ç‚¬æˆç°æ³ªå§‹å¹²ã€‚**
> **æ™“é•œä½†æ„äº‘é¬“æ”¹ï¼Œå¤œåŸåº”è§‰æœˆå…‰å¯’ã€‚**
> **è“¬å±±æ­¤å»æ— å¤šè·¯ï¼Œé’é¸Ÿæ®·å‹¤ä¸ºæ¢çœ‹ã€‚**
> â€”â€” æå•†éšã€Šæ— é¢˜ã€‹

ğŸŒŒ é’é¸Ÿ - é›¶é…ç½®ä¼˜å…ˆçš„é€šç”¨å‘å¸ƒå·¥å…·ï¼Œä¸“ä¸º monorepo é¡¹ç›®è®¾è®¡

## ğŸ“– å…³äºé’é¸Ÿ

é’é¸Ÿæ˜¯ä¸­å›½ç¥è¯ä¸­è¥¿ç‹æ¯çš„ä¿¡ä½¿ï¼Œè´Ÿè´£å°†æ¶ˆæ¯å’Œç‰©å“å‡†ç¡®ã€åŠæ—¶åœ°ä¼ é€’åˆ°äººé—´ã€‚æ­£å¦‚æå•†éšã€Šæ— é¢˜ã€‹æ‰€æç»˜ï¼š"è“¬å±±æ­¤å»æ— å¤šè·¯ï¼Œé’é¸Ÿæ®·å‹¤ä¸ºæ¢çœ‹"ï¼Œé’é¸Ÿå·¥å…·å¦‚è¯—ä¸­çš„ä¿¡ä½¿ä¸€èˆ¬ï¼Œæ®·å‹¤åœ°å°†æ‚¨çš„ä»£ç åŒ…å‡†ç¡®ã€ä¼˜é›…åœ°ä¼ é€’åˆ° NPM ä»“åº“ï¼Œå³ä½¿å‰è·¯é¥è¿œï¼Œä¹Ÿå¿…ä½¿å‘½å¿…è¾¾ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ¯ é›¶é…ç½®ä¼˜å…ˆ

- **è‡ªåŠ¨æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹åŒ…ç®¡ç†å™¨ã€workspace ç±»å‹ã€æ„å»ºå·¥å…·ï¼ˆTurbo/Nxï¼‰
- **æ™ºèƒ½æ¨æ–­**ï¼šä»é¡¹ç›®ç»“æ„è‡ªåŠ¨æ¨æ–­æ„å»ºæ­¥éª¤ã€äº§ç‰©è·¯å¾„ã€ç‰ˆæœ¬ç­–ç•¥
- **å¼€ç®±å³ç”¨**ï¼šå¤§å¤šæ•°é¡¹ç›®æ— éœ€é…ç½®æ–‡ä»¶å³å¯ä½¿ç”¨

### ğŸš€ æ·±åº¦é›†æˆ

- **pnpm/yarn/npm workspace**ï¼šå®Œæ•´æ”¯æŒï¼Œè‡ªåŠ¨å¤„ç†ä¾èµ–é¡ºåº
- **Changeset**ï¼šæ·±åº¦é›†æˆï¼Œè‡ªåŠ¨æ£€æµ‹å’Œä½¿ç”¨ changeset
- **Turbo/Nx**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨æ„å»ºå·¥å…·çš„ä¾èµ–å›¾
- **Git**ï¼šè‡ªåŠ¨å¤„ç†ç‰ˆæœ¬æäº¤ã€æ ‡ç­¾åˆ›å»ºã€è¿œç¨‹æ¨é€

### âš™ï¸ çµæ´»é…ç½®

- **é…ç½®æ–‡ä»¶å¯é€‰**ï¼šä»…åœ¨éœ€è¦æ—¶è¦†ç›–è‡ªåŠ¨æ£€æµ‹ç»“æœ
- **éƒ¨åˆ†è¦†ç›–**ï¼šåªéœ€é…ç½®éœ€è¦è‡ªå®šä¹‰çš„éƒ¨åˆ†
- **å¤šç§æ ¼å¼**ï¼šæ”¯æŒ JSONã€JavaScriptã€TypeScript é…ç½®æ–‡ä»¶

## ğŸ“¦ å®‰è£…

```bash
# å…¨å±€å®‰è£…
npm install -g @systembug/qingniao

# æˆ–é¡¹ç›®æœ¬åœ°å®‰è£…
pnpm add -D @systembug/qingniao
# æˆ–
npm install --save-dev @systembug/qingniao
# æˆ–
yarn add -D @systembug/qingniao
```

### å¯é€‰ä¾èµ–

å¦‚æœä½¿ç”¨ changeset è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œéœ€è¦å•ç‹¬å®‰è£… `@changesets/cli`ï¼š

```bash
pnpm add -D @changesets/cli
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### é›¶é…ç½®ä½¿ç”¨ï¼ˆæ¨èï¼‰

åœ¨æ ‡å‡† monorepo é¡¹ç›®ä¸­ï¼Œç›´æ¥è¿è¡Œï¼š

```bash
qingniao
# æˆ–ä½¿ç”¨ç®€çŸ­å‘½ä»¤
qn
```

å·¥å…·ä¼šè‡ªåŠ¨ï¼š

- æ£€æµ‹ pnpm/yarn/npm workspace
- å‘ç°æ‰€æœ‰å¯å‘å¸ƒçš„åŒ…ï¼ˆè‡ªåŠ¨æ’é™¤ç§æœ‰åŒ…ï¼‰
- æ£€æµ‹å¹¶ä½¿ç”¨ changesetï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- ä» package.json æ¨æ–­æ„å»ºæ­¥éª¤
- è‡ªåŠ¨å¤„ç†ç‰ˆæœ¬ç®¡ç†å’Œå‘å¸ƒ

### åœ¨ package.json ä¸­æ·»åŠ è„šæœ¬

```json
{
  "scripts": {
    "release": "qingniao",
    "release:dry-run": "qingniao --dry-run"
  }
}
```

ç„¶åè¿è¡Œï¼š

```bash
pnpm release
```

## ğŸ¯ é›¶é…ç½®è‡ªåŠ¨æ£€æµ‹

é’é¸Ÿå·¥å…·ä¼šè‡ªåŠ¨æ£€æµ‹ä»¥ä¸‹ä¿¡æ¯ï¼Œ**æ— éœ€ä»»ä½•é…ç½®æ–‡ä»¶**ï¼š

```mermaid
graph LR
    A[é¡¹ç›®æ ¹ç›®å½•] --> B[æ£€æµ‹åŒ…ç®¡ç†å™¨]
    A --> C[æ£€æµ‹ Workspace]
    A --> D[æ£€æµ‹æ„å»ºå·¥å…·]
    A --> E[æ£€æµ‹ç‰ˆæœ¬ç­–ç•¥]
    A --> F[å‘ç°åŒ…åˆ—è¡¨]

    B --> G[package.json<br/>packageManager]
    C --> H[pnpm-workspace.yaml<br/>æˆ– package.json workspaces]
    D --> I[turbo.json<br/>æˆ– nx.json]
    E --> J[.changeset ç›®å½•]
    F --> K[pnpm list<br/>æˆ–æ¨¡å¼åŒ¹é…]

    G --> L[è‡ªåŠ¨é…ç½®]
    H --> L
    I --> L
    J --> L
    K --> L

    style A fill:#e3f2fd
    style L fill:#c8e6c9
```

### è‡ªåŠ¨æ£€æµ‹é¡¹

- âœ… **åŒ…ç®¡ç†å™¨**ï¼šä» `package.json` çš„ `packageManager` å­—æ®µæ£€æµ‹
- âœ… **Workspace ç±»å‹**ï¼šä» `pnpm-workspace.yaml`ã€`package.json` workspaces è‡ªåŠ¨æ£€æµ‹
- âœ… **åŒ…åˆ—è¡¨**ï¼šä½¿ç”¨åŒ…ç®¡ç†å™¨å‘½ä»¤è‡ªåŠ¨å‘ç°æ‰€æœ‰åŒ…
- âœ… **åŒ…è¿‡æ»¤**ï¼šè‡ªåŠ¨æ’é™¤ç§æœ‰åŒ…ï¼ˆ`private: true`ï¼‰å’Œæ— æ•ˆé…ç½®çš„åŒ…
- âœ… **ç‰ˆæœ¬ç­–ç•¥**ï¼šæ£€æµ‹ `.changeset` ç›®å½•ï¼Œè‡ªåŠ¨é€‰æ‹© changeset æˆ– manual ç­–ç•¥
- âœ… **æ„å»ºå·¥å…·**ï¼šä» `turbo.json` æˆ– `nx.json` è‡ªåŠ¨æ£€æµ‹ Turbo/Nx
- âœ… **æ„å»ºæ­¥éª¤**ï¼šä» `package.json` scripts è‡ªåŠ¨ç”Ÿæˆæ„å»ºæ­¥éª¤
- âœ… **æ„å»ºäº§ç‰©è·¯å¾„**ï¼šä»æ¯ä¸ªåŒ…çš„ `package.json` è‡ªåŠ¨æ¨æ–­ï¼ˆmain/module/types å­—æ®µï¼‰
- âœ… **Git åˆ†æ”¯**ï¼šè‡ªåŠ¨æ£€æµ‹å½“å‰åˆ†æ”¯
- âœ… **ä¾èµ–é¡ºåº**ï¼šè‡ªåŠ¨åˆ†æ workspace ä¾èµ–å…³ç³»ï¼Œæ‹“æ‰‘æ’åº

### åŒ…å‘å¸ƒéªŒè¯

é’é¸Ÿä¼šè‡ªåŠ¨éªŒè¯æ¯ä¸ªåŒ…çš„å‘å¸ƒé…ç½®ï¼š

- âœ… æ£€æŸ¥æ˜¯å¦ä¸ºç§æœ‰åŒ…ï¼ˆè‡ªåŠ¨æ’é™¤ï¼‰
- âœ… å¯¹äº scoped packagesï¼ˆå¦‚ `@systembug/xxx`ï¼‰ï¼Œæ£€æŸ¥ `publishConfig.access` æ˜¯å¦ä¸º `"public"`
- âœ… æ˜¾ç¤ºè¯¦ç»†çš„éªŒè¯é”™è¯¯å’Œè­¦å‘Š

## ğŸ“‹ å‘å¸ƒæµç¨‹

é’é¸Ÿçš„å‘å¸ƒæµç¨‹å¦‚ä¸‹ï¼š

```mermaid
flowchart TD
    A[å¼€å§‹å‘å¸ƒ] --> B[ç¯å¢ƒæ£€æŸ¥]
    B --> C{NPM è®¤è¯}
    C -->|æœªç™»å½•| D[æç¤ºç™»å½•]
    C -->|å·²ç™»å½•| E[Git çŠ¶æ€æ£€æŸ¥]
    E --> F{å·¥ä½œåŒºå¹²å‡€?}
    F -->|å¦| G[æç¤ºæäº¤æ›´æ”¹]
    F -->|æ˜¯| H[ç‰ˆæœ¬ç®¡ç†]
    H --> I{éœ€è¦æ›´æ–°ç‰ˆæœ¬?}
    I -->|æ˜¯| J[é€‰æ‹©ç‰ˆæœ¬ç±»å‹]
    J --> K[æ›´æ–°æ‰€æœ‰åŒ…ç‰ˆæœ¬]
    I -->|å¦| L[æ„å»ºéªŒè¯]
    K --> L
    L --> M[å®‰è£…ä¾èµ–]
    M --> N[ä»£ç æ£€æŸ¥]
    N --> O[ç±»å‹æ£€æŸ¥]
    O --> P[è¿è¡Œæµ‹è¯•]
    P --> Q[æ„å»ºæ‰€æœ‰åŒ…]
    Q --> R[éªŒè¯æ„å»ºäº§ç‰©]
    R --> S[å‘å¸ƒåˆ° NPM]
    S --> T[å®Œæˆ]

    style A fill:#e1f5ff
    style T fill:#c8e6c9
    style D fill:#ffcdd2
    style G fill:#ffcdd2
```

### è¯¦ç»†æ­¥éª¤

1. **ç¯å¢ƒæ£€æŸ¥**
   - NPM è®¤è¯æ£€æŸ¥
   - Git çŠ¶æ€æ£€æŸ¥ï¼ˆå·¥ä½œåŒºå¹²å‡€ï¼‰
   - è¿œç¨‹åŒæ­¥æ£€æŸ¥

2. **ç‰ˆæœ¬ç®¡ç†**ï¼ˆå¯é€‰ï¼‰
   - é€‰æ‹©ç‰ˆæœ¬ç±»å‹ï¼ˆmajor/minor/patchï¼‰
   - æ›´æ–°æ‰€æœ‰åŒ…çš„ç‰ˆæœ¬å·ï¼ˆåŒ…æ‹¬æ ¹ç›®å½•ï¼‰
   - åŒæ­¥ workspace ä¾èµ–ç‰ˆæœ¬
   - æäº¤åˆ° Git å¹¶åˆ›å»ºæ ‡ç­¾

3. **æ„å»ºéªŒè¯**
   - æ¸…ç†æ„å»ºäº§ç‰©
   - å®‰è£…ä¾èµ–
   - ä»£ç æ£€æŸ¥ï¼ˆESLintï¼‰
   - ç±»å‹æ£€æŸ¥ï¼ˆTypeScriptï¼‰
   - è¿è¡Œæµ‹è¯•
   - æ„å»ºæ‰€æœ‰åŒ…ï¼ˆTurbo/Nxï¼‰
   - éªŒè¯æ„å»ºäº§ç‰©

4. **å‘å¸ƒåˆ° NPM**
   - æ˜¾ç¤ºå°†è¦å‘å¸ƒçš„åŒ…åˆ—è¡¨
   - æ£€æŸ¥å·²å­˜åœ¨çš„ç‰ˆæœ¬
   - Dry-run æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
   - æ­£å¼å‘å¸ƒ

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬å‘å¸ƒ

```bash
# 1. ç¡®ä¿ä»£ç å·²æäº¤
git add .
git commit -m "feat: æ–°åŠŸèƒ½"

# 2. è¿è¡Œå‘å¸ƒ
pnpm release

# 3. æŒ‰ç…§æç¤ºæ“ä½œ
# - é€‰æ‹©æ˜¯å¦æ›´æ–°ç‰ˆæœ¬
# - é€‰æ‹©ç‰ˆæœ¬ç±»å‹ï¼ˆmajor/minor/patchï¼‰
# - ç¡®è®¤å‘å¸ƒ
```

### è·³è¿‡ç‰ˆæœ¬æ›´æ–°

```bash
# åªå‘å¸ƒï¼Œä¸æ›´æ–°ç‰ˆæœ¬
qingniao --skip-version
```

### ä»…éªŒè¯æ„å»º

```bash
# ä¸å‘å¸ƒï¼ŒåªéªŒè¯æ„å»º
qingniao --skip-publish
```

### éäº¤äº’æ¨¡å¼ï¼ˆCI/CDï¼‰

```bash
# è·³è¿‡æ‰€æœ‰ç¡®è®¤æç¤º
qingniao --yes
```

### Dry-run æ¨¡å¼

```bash
# æ‰§è¡Œå®Œæ•´æµç¨‹ä½†ä¸å®é™…å‘å¸ƒ
qingniao --dry-run
```

## ğŸ”§ è‡ªå®šä¹‰é…ç½®ï¼ˆå¯é€‰ï¼‰

**é»˜è®¤æƒ…å†µä¸‹ï¼Œå®Œå…¨ä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼** æ‰€æœ‰é…ç½®éƒ½è‡ªåŠ¨æ£€æµ‹ã€‚

å¦‚æœç¡®å®éœ€è¦è¦†ç›–æŸäº›è‡ªåŠ¨æ£€æµ‹çš„ç»“æœï¼Œå¯ä»¥åˆ›å»º `qingniao.config.json`ï¼š

```json
{
    "git": {
        "branch": "develop" // è¦†ç›–ï¼šé»˜è®¤è‡ªåŠ¨æ£€æµ‹å½“å‰åˆ†æ”¯
    },
    "build": {
        "steps": [
            // è¦†ç›–ï¼šé»˜è®¤ä» package.json scripts è‡ªåŠ¨ç”Ÿæˆ
        ]
    }
}
```

### é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§

1. å‘½ä»¤è¡Œ `--config` æŒ‡å®šçš„æ–‡ä»¶
2. `qingniao.config.json`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
3. `package.json` ä¸­çš„ `qingniao` å­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
4. **é›¶é…ç½®è‡ªåŠ¨æ£€æµ‹**ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰

### å®Œæ•´é…ç½®ç¤ºä¾‹

```typescript
// qingniao.config.ts
import { PublishConfig } from "@systembug/qingniao";

export default {
    project: {
        name: "My Project",
        packageManager: "pnpm",
    },
    git: {
        branch: "main",
        tagPrefix: "v",
    },
    version: {
        strategy: "changeset",
        syncAll: true,
    },
    build: {
        useNx: true, // æˆ– useTurbo: true
        nxTargets: ["build"], // æˆ– turboTasks: ["build"]
    },
    publish: {
        skipExisting: true,
    },
} satisfies PublishConfig;
```

## ğŸ” æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### ç‰ˆæœ¬ç®¡ç†

- **Changeset é›†æˆ**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œä½¿ç”¨ changeset
- **æ‰‹åŠ¨ç‰ˆæœ¬**ï¼šæ”¯æŒ major/minor/patch æ‰‹åŠ¨é€‰æ‹©
- **ç‰ˆæœ¬åŒæ­¥**ï¼šè‡ªåŠ¨åŒæ­¥æ‰€æœ‰ workspace åŒ…çš„ç‰ˆæœ¬ï¼ˆåŒ…æ‹¬æ ¹ç›®å½•ï¼‰
- **Workspace åè®®**ï¼šè‡ªåŠ¨æ›¿æ¢ `workspace:*` ä¸ºå®é™…ç‰ˆæœ¬

### æ„å»ºéªŒè¯

- **è‡ªåŠ¨æ¨æ–­**ï¼šä» package.json scripts è‡ªåŠ¨ç”Ÿæˆæ„å»ºæ­¥éª¤
- **äº§ç‰©éªŒè¯**ï¼šè‡ªåŠ¨æ£€æµ‹å’ŒéªŒè¯æ„å»ºäº§ç‰©
- **ä¾èµ–é¡ºåº**ï¼šæŒ‰ä¾èµ–å…³ç³»æ‹“æ‰‘æ’åºæ„å»º
- **Pre-lint æ„å»º**ï¼šæ”¯æŒåœ¨ lint ä¹‹å‰æ„å»ºç‰¹å®šåŒ…ï¼ˆå¦‚ eslint-pluginï¼‰

### NPM å‘å¸ƒ

- **æ™ºèƒ½å‘å¸ƒ**ï¼šæŒ‰ä¾èµ–é¡ºåºå‘å¸ƒåŒ…
- **Dry-run æ”¯æŒ**ï¼šå‘å¸ƒå‰éªŒè¯
- **OTP æ”¯æŒ**ï¼šè‡ªåŠ¨å¤„ç† 2FA è®¤è¯
- **é”™è¯¯å¤„ç†**ï¼šè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤å»ºè®®

## ğŸ¨ é’é¸Ÿå“²å­¦

æ­£å¦‚å¤è¯—æ‰€æç»˜çš„ï¼Œé’é¸Ÿä½œä¸ºä¿¡ä½¿å…·æœ‰ä»¥ä¸‹ç‰¹è´¨ï¼š

- **æ®·å‹¤**ï¼šä¸»åŠ¨æ£€æµ‹å’Œæ¨æ–­ï¼Œæ— éœ€ç¹çé…ç½®
- **å¯é **ï¼šç¡®ä¿ç‰ˆæœ¬åŒæ­¥ã€ä¾èµ–æ­£ç¡®ã€æ„å»ºå®Œæ•´
- **ä¼˜é›…**ï¼šæä¾›æµç•…çš„å‘å¸ƒä½“éªŒï¼Œå¦‚é’é¸Ÿé£è¡Œèˆ¬ä¼˜é›…
- **æ™ºèƒ½**ï¼šè‡ªåŠ¨å¤„ç†å¤æ‚é€»è¾‘ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºä»£ç 

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [RFC 0001: é’é¸Ÿé€šç”¨å‘å¸ƒå·¥å…·è®¾è®¡è§„èŒƒ](../rfc/0001-universal-publish-tool.md)

---

> **è“¬å±±æ­¤å»æ— å¤šè·¯ï¼Œé’é¸Ÿæ®·å‹¤ä¸ºæ¢çœ‹**
> è®©ä»£ç å‘å¸ƒå¦‚é’é¸Ÿä¼ é€’æ¶ˆæ¯èˆ¬ä¼˜é›…æµç•…ï¼

